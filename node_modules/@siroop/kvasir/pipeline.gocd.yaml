pipelines:
  kvasir_build_dev:
    group: kvasir
    label_template: "${kvasir_git[:8]}"
    materials:
      kvasir_git:
        git: git@github.com:ProjectThor/kvasir.git
        branch: develop
    stages:
      - build:
          clean_workspace: yes
          jobs:
            build:
              artifacts:
               - build:
                   source: ops/infra
              tasks:
               - exec:
                   command: make
                   arguments: [bootstrap, test, build_ci, push_ci]
               - exec:
                   command: make
                   arguments: [teardown]
                   run_if: any
  kvasir_DEV:
      group: kvasir
      label_template: "${kvasir_build_dev}"
      locking: on
      materials:
        kvasir_build_dev:
          pipeline: kvasir_build_dev
          stage: build
        infra_DEV:
          pipeline: infra_DEV
          stage: deploy
      stages:
        - deploy:
            clean_workspace: yes
            jobs:
              deploy:
                tasks:
                 - fetch:
                     pipeline: kvasir_build_dev
                     stage: build
                     job: build
                     source: infra
                 - fetch:
                     pipeline: infra_DEV
                     stage: deploy
                     job: deploy
                     source: build
                 - exec:
                     command: /bin/bash
                     arguments: [-c, mkdir environment && tar -xvf build/infra_build*.tgz --strip-components=1 -C environment infra]
                 - exec:
                     working_directory: infra
                     command: /bin/bash
                     arguments: [-c, chmod +x deploy.sh && ./deploy.sh tools plan dev]
                 - exec:
                     working_directory: infra
                     command: /bin/bash
                     arguments: [-c, chmod +x deploy.sh && ./deploy.sh tools apply dev]
  kvasir_build_prod:
    group: kvasir
    label_template: "${kvasir_git[:8]}"
    materials:
      kvasir_git:
        git: git@github.com:ProjectThor/kvasir.git
        branch: develop
    stages:
      - build:
          clean_workspace: yes
          jobs:
            build:
              artifacts:
               - build:
                   source: ops/infra
              tasks:
               - exec:
                   command: make
                   arguments: [bootstrap, build_ci, push_ci]
  kvasir_PROD:
      group: kvasir
      label_template: "${kvasir_build_prod}"
      locking: on
      materials:
        kvasir_build_prod:
          pipeline: kvasir_build_prod
          stage: build
        infra_DEV:
          pipeline: infra_DEV
          stage: deploy
      stages:
        - deploy:
            clean_workspace: yes
            jobs:
              deploy:
                tasks:
                 - fetch:
                     pipeline: kvasir_build_prod
                     stage: build
                     job: build
                     source: infra
                 - fetch:
                     pipeline: infra_DEV
                     stage: deploy
                     job: deploy
                     source: build
                 - exec:
                     command: /bin/bash
                     arguments: [-c, mkdir environment && tar -xvf build/infra_build*.tgz --strip-components=1 -C environment infra]
                 - exec:
                     working_directory: infra
                     command: /bin/bash
                     arguments: [-c, chmod +x deploy.sh && ./deploy.sh tools plan prod]
                 - exec:
                     working_directory: infra
                     command: /bin/bash
                     arguments: [-c, chmod +x deploy.sh && ./deploy.sh tools apply prod]
