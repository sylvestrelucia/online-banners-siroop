const autoprefixer = require('autoprefixer');
const postcsswrap = require('postcss-wrap');

module.exports = (gulp, plugins, options) => () => {
	const stream = gulp.src(options.pathSrc)
		.pipe(options.sourcemaps ? plugins.sourcemaps.init() : plugins.util.noop())
		.pipe(plugins.sassGlob())
		.pipe(plugins.sass(options.sassConfig).on('error', plugins.sass.logError))
		.pipe(plugins.postcss([autoprefixer(options.autoprefixerConfig)]))
		.pipe(options.cssKvasirPrefix ?
			plugins.postcss([postcsswrap(options.postcsswrapConfig)]) : plugins.util.noop())
		.pipe(options.sourcemaps ? plugins.sourcemaps.write() : plugins.util.noop())
		.pipe(plugins.flatten()) // remove stored relative path
		.pipe(options.cssMin ? plugins.cleanCss({ debug: true }) : plugins.util.noop())
		.pipe(options.cssMin ? plugins.rename({ suffix: '.min' }) : plugins.util.noop())
		.pipe(gulp.dest(options.pathDest));

	return stream;
};

