const path = require('path');

module.exports = (gulp, plugins, options) => () => {
	const stream = gulp.src(options.paths.js.src)
		.pipe(plugins.cached('eslint'))
		// Only uncached and changed files past this point
		.pipe(plugins.eslint(options.eslintConfig))
		.pipe(plugins.eslint.format())
		.pipe(plugins.eslint.result((result) => {
			if (result.warningCount > 0 || result.errorCount > 0) {
				// If a file has errors/warnings remove uncache it
				delete plugins.cached.caches.eslint[path.resolve(result.filePath)];
			}
		}));

	if (options.eslintConfig.failOnError) {
		return stream.pipe(plugins.eslint.failAfterError());
	}

	return stream;
};
