#!/bin/bash

if [[ "$1" == "-h"  || "$#" -lt 3 ]]; then
  echo "Usage: ./build.sh <env-name> <make-target> <stage>"
  exit 0
fi

label_name=kvasir_build_$3

if [ ! -d "../environment" ]; then
  git clone git@github.com:ProjectThor/resiroop-infra.git ../environment
fi

if [ ! -f "../environment/.env" ]; then
   cp ../../.env ../environment/
fi

cp env-tools.tfvars env-tools.tfvars.backup
echo "deploy_stage = \"$3\"" >> env-tools.tfvars

cd  ../environment && ./build_service.sh $1 $label_name $2 || true

cd ../infra
rm -f env-tools.tfvars
mv env-tools.tfvars.backup env-tools.tfvars
