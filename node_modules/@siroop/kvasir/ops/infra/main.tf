// ******************************************************************
// AWS
// ******************************************************************

variable "region" { default = "eu-central-1"  }
provider "aws"    { region  = "${var.region}" }
terraform         { backend "s3" {}           }

// ******************************************************************
// Environment
// ******************************************************************

variable "environment" {
  description = "Environment used for the setup."
  default     = "tools"
}

variable "deploy_version" {
  description = "Version of the resiroop styleguide that should be deployed."
  default     = "latest"
}

variable "deploy_stage" {
  description = "Stage to be deployed."
}

variable "dns_zone_design" {
  description = "DNS hosted zone for *.siroop.design"
  default = "Z2MRRMPOEN50JQ"
}

// ******************************************************************
// Service definition
// ******************************************************************

module "kvasir-styleguide" {
  source           = "../../modules/service-admin"
  environment      = "tools"
  deploy_version   = "${var.deploy_version}"
  name             = "${format("kvasir-%s", var.deploy_stage == "prod" ? "styleguide" : var.deploy_stage)}"
  image            = "projectthor/kvasir"
  container_port   = "3000"
  healthcheck_path = "/"
  domain           = "${var.deploy_stage == "prod" ? "*.siroop.design" : ""}"
  env_vars = <<EOF
  [
    { "name": "DEPLOY_STAGE", "value": "${var.deploy_stage}" }
  ]
EOF
}

resource "aws_route53_record" "dns" {
  count   = "${var.deploy_stage == "prod" ? 1 : 0}"
  zone_id = "${var.dns_zone_design}"
  name    = "styleguide.siroop.design"
  ttl     = "60"
  type    = "CNAME"
  records = ["kvasir-styleguide.tools.resiroop.ch"]
}
