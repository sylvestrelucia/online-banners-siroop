FROM node:carbon

ENV PHANTOMJS_BIN "/usr/local/bin/phantomjs"

RUN echo 'deb http://dl.yarnpkg.com/debian/ stable main' > /etc/apt/sources.list.d/yarn.list && \
    echo 'deb http://packages.dotdeb.org jessie all' > /etc/apt/sources.list.d/dotdeb.list && \
    curl -sS https://www.dotdeb.org/dotdeb.gpg | apt-key add - && \
    curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
      apt-transport-https \
      nginx \
      php7.0 \
      supervisor \
      yarn \
    && \
    apt-get autoremove -y && apt-get clean

# Install Phantomjs to run tests
RUN yarn global add phantomjs-prebuilt

# Create app directory
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app/

COPY conf/nginx-kvasir.conf /etc/nginx/sites-enabled/nginx-kvasir.conf

# Install app dependencies
COPY package.json /usr/src/app/
RUN yarn install --silent

# Bundle app source
COPY . /usr/src/app

EXPOSE 8080
CMD [ "yarn", "start" ]
